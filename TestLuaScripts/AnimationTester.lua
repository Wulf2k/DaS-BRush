ANIM_ID = { 1, 2, 3, 5, 30, 33, 40, 41, 42, 43, 44, 45, 60, 61, 62, 63, 65, 66, 67, 68, 70, 71, 72, 73, 80, 81, 82, 83, 85, 86, 87, 88, 90, 91, 92, 93, 95, 96, 100, 101, 102, 103, 104, 105, 106, 107, 108, 110, 116, 117, 118, 130, 131, 132, 136, 137, 138, 140, 141, 142, 145, 146, 147, 150, 151, 152, 160, 162, 164, 200, 201, 202, 203, 204, 205, 206, 207, 210, 212, 214, 300, 301, 302, 303, 310, 311, 312, 313, 500, 501, 502, 503, 510, 511, 515, 517, 519, 520, 522, 524, 530, 531, 535, 536, 540, 541, 545, 546, 550, 551, 552, 553, 560, 561, 562, 563, 602, 603, 604, 605, 610, 620, 621, 640, 680, 690, 695, 696, 697, 698, 700, 701, 702, 703, 710, 711, 712, 713, 720, 721, 722, 723, 730, 731, 732, 733, 735, 736, 737, 738, 740, 741, 742, 743, 760, 761, 770, 800, 801, 802, 803, 804, 805, 806, 807, 900, 1500, 1510, 1520, 1550, 1560, 1570, 1580, --[[1600, 1610, 1620, Death]] 1650, 1660, 1670, 1750, 1755, 1760, 1765, 1766, 1767, 1770, 1780, 1790, 1800, 1801, 1802, 1803, 2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2020, 2021, 2022, 2024, 2025, 2026, 2027, 2030, 2031, 2032, 2033, 2034, 2035, 2036, 2037, 2040, 2045, 2050, 2051, 2052, 2053, 2054, 2055, 2056, 2057, 2060, 2061, 2062, 2063, 2064, 2065, 2066, 2067, 2070, 2071, 2072, 2073, 2075, 2076, 2077, 2080, 2081, 2082, 2083, 2085, 2086, 2087, 2088, 2100, 2101, 2200, 2201, 2202, 2203, 2204, 2205, 2206, 2207, 2210, 2211, 2212, 2213, 6000, 6001, 6010, 6011, 6020, 6021, 6030, 6031, 6040, 6041, 6050, 6051, 6052, 6053, 6055, 6060, 6065, 6066, 6067, 6070, 6071, 6072, 6073, 6074, 6075, 6076, 6080, 6081, 6082, 6083, 6084, 6100, 6101, 6110, 6111, 6120, 6121, 6130, 6131, 6140, 6141, 6150, 6151, 6152, 6153, 6155, 6160, 6165, 6170, 6171, 6172, 6173, 6174, 6175, 6176, 6180, 6181, 6182, 6183, 6184, 6200, 6201, 6202, 6203, 6204, 6205, 6206, 6207, 6208, 6209, 6210, 6211, 6212, 6213, 6214, 6215, 6216, 6217, 6218, 6219, 6220, 6221, 6222, 6224, 6225, 6226, 6299, 6300, 6302, 6303, 6304, 6305, 6306, 6307, 6308, 6309, 6310, 6311, 6312, 6313, 6314, 6315, 6316, 6317, 6318, 6319, 6320, 6322, 6324, 6325, 6326, 6399, 6400, 6401, 6402, 6403, 6404, 6405, 6406, 6407, 6408, 6409, 6410, 6411, 6412, 6413, 6414, 6415, 6416, 6417, 6418, 6419, 6420, 6422, 6424, 6425, 6426, 6500, 6502, 6503, 6504, 6505, 6506, 6507, 6508, 6509, 6510, 6511, 6512, 6513, 6514, 6515, 6516, 6517, 6518, 6519, 6520, 6522, 6524, 6525, 6526, 6600, 6613, 6625, 6725, 6800, 6801, 6802, 6803, 6804, 6805, 6806, 6807, 6808, 6809, 6810, 6815, 6820, 6825, 6830, 6950, 6951, 6952, 7000, 7001, 7002, 7003, 7004, 7005, 7010, 7011, 7012, 7013, 7014, 7020, 7021, 7022, 7023, 7024, 7030, 7031, 7033, 7035, 7036, 7037, 7038, 7040, 7041, 7043, 7045, 7046, 7047, 7048, 7050, 7051, 7052, 7060, 7061, 7062, 7063, 7064, 7110, 7111, 7112, 7113, 7114, 7120, 7150, 7151, 7152, 7410, 7411, 7412, 7413, 7414, 7500, 7501, 7502, 7503, 7504, 7510, 7520, 7521, 7522, 7530, 7540, 7541, 7550, 7560, 7561, 7562, 7570, 7571, 7580, 7585, 7586, 7587, 7588, 7589, 7600, 7605, 7610, 7615, 7620, 7625, 7630, 7635, 7640, 7645, 7697, 7698, 7699, 7700, 7701, 7702, 7710, 7711, 7712, 7720, 7721, 7722, 7725, 7800, 7801, 7802, 7805, 7810, 7815, 7816, 7817, 7820, 7821, 7825, 7830, 7835, 7840, 7845, 7850, 7855, 7856, 7860, 7865, 7870, 7875, 7876, 7877, 7880, 7885, 7890, 7891, 7895, 7896, 7897, 7898, 7900, 7905, 7910, 7911, 7912, 7913, 8000, 8001, 8005, 8006, 8010, 8020, 8021, 8022, 8023, 8130, 8280, 8281, 8282, 8283, 8284, 8285, 8286, 8287, 8288, 8289, 8290, 8300, 8305, 8400, 8401, 8402, 9000, 9001, 9002, 9010, 9011, 9012, 9020, 9021, 9022, 9023, 9024, 9030, 9031, 9032, 9033, 9034, 9040, 9041, 9042, 9043, 9044, 9050, 9051, 9052, 9060, 9061, 9062, 9063, 9064, 9070, 9071, 9072, 9080, 9081, 9082, 9090, 9091, 9092, 9093, 9094, 9100, 9101, 9102, 9103, 9104, 9110, 9111, 9112, 9120, 9121, 9122, 9130, 9131, 9132, 9140, 9141, 9142, 9143, 9144, 9150, 9151, 9152, 9153, 9154, 9160, 9161, 9162, 9163, 9164, 9170, 9171, 9172, 9190, 9191, 9192, 9200, 9201, 9202, 9203, 9210, 9211, 9212, 9220, 9221, 9222, 9223, 9224, 9230, 9231, 9232, 9233, 9234, 9240, 9241, 9242, 9250, 9251, 9252, 9253, 9254, 9260, 9261, 9262, 9263, 9264, 9270, 9271, 9272, 9273, 9274, 9280, 9281, 9282, 9290, 9291, 9292, 9300, 9301, 9302, 9303, 9304, 9310, 9311, 9312, 9313, 9314, 9320, 9321, 9322, 9330, 9331, 9332, 9340, 9341, 9342, 9343, 9344, 9350, 9351, 9352, 9360, 9361, 9362, 9370, 9371, 9372, 9380, 9381, 9382, 9383, 9384, 9390, 9391, 9392, 9400, 9401, 9402, 9410, 9411, 9412, 9420, 9421, 9422, 9430, 9431, 9432, 9440, 9441, 9442, 9450, 9451, 9452, 9460, 9600, 9610, 9990, 233980, 423980 }

xinput_dll_offset = GetIngameDllAddress("XInput1_3.dll"); --The address "XInput1_3.dll + 0x0"
BTN_A        = 0x1000
BTN_B        = 0x2000
BTN_X        = 0x4000
BTN_Y        = 0x8000
BTN_LB       = 0x0100
BTN_RB       = 0x0200
BTN_HOME     = 0x0400
BTN_BACK     = 0x0020
BTN_LThumb   = 0x0040
BTN_RThumb   = 0x0080
BTN_START    = 0x0010
BTN_UP       = 0x0001
BTN_DOWN     = 0x0002
BTN_LEFT     = 0x0004
BTN_RIGHT    = 0x0008
BTN_CROSS    = 0x1000
BTN_CIRCLE   = 0x2000
BTN_SQUARE   = 0x4000
BTN_TRIANGLE = 0x8000
BTN_L1       = 0x0100
BTN_R1       = 0x0200
BTN_PS       = 0x0400
BTN_SELECT   = 0x0020
BTN_L3       = 0x0040
BTN_R3       = 0x0080

animId = 1;
mode = "Auto"

textPosX = 256;
textPosY = 16;

buttonBitmaskTextFormat = "ButtonMask: %04x";
buttonBitmaskTextPosX = textPosX;
buttonBitmaskTextPosY = textPosY + 24;

buttonBitmaskValue = 0;
prevButtonBitmaskValue = 0;

prevAnimId = 1

function SetTextPositions()
    SetLineHelpTextPos(buttonBitmaskTextPosX, buttonBitmaskTextPosY);
    SetKeyGuideTextPos(textPosX, textPosY);
end

function CheckButton(maskTest)
    return BitmaskCheck(buttonBitmaskValue, maskTest);
end

function CheckPrevButton(maskTest)
    return BitmaskCheck(prevButtonBitmaskValue, maskTest);
end

function CheckButtonPressed(maskTest)
    cur = CheckButton(maskTest);
    prev = CheckPrevButton(maskTest);
    
    return (cur and (not prev));
end

function BoolString(boolVal)
    if boolVal then
        return "true"
    else
        return "false"
    end
end

function ReadController()
    addr = RInt32(RInt32(xinput_dll_offset + 0x10C44)) + 0x0028
    buttonBitmaskValue = RUInt16(addr);
end

function GoToAnim(a)
    StopLoopAnimation(10000, animId);
    animId = math.max(math.min(a, #ANIM_ID), 1);
    if (mode == "Auto") then
        ForcePlayLoopAnimation(10000, ANIM_ID[animId]);
    end
    
    prevAnimId = animId
end

function NextAnim(delta)
    GoToAnim(animId + delta);
end

function PrevAnim(delta)
    GoToAnim(animId - delta);
end

function UpdatePlayback()
    
    deltaVal = 1;
    
    if CheckButton(BTN_L1) then
        deltaVal = deltaVal * 10
    end
    
    if CheckButtonPressed(BTN_TRIANGLE) then
        mode = "Auto"
        StopLoopAnimation(10000, ANIM_ID[prevAnimId]);
        ForcePlayLoopAnimation(10000, ANIM_ID[animId]);
    elseif CheckButtonPressed(BTN_CROSS) then
        mode = "Once"
        StopLoopAnimation(10000, ANIM_ID[prevAnimId]);
        ForcePlayAnimation(10000, ANIM_ID[animId]);
    elseif CheckButtonPressed(BTN_CIRCLE) then
        mode = "Stop"
        StopLoopAnimation(10000, ANIM_ID[prevAnimId]);
        StopLoopAnimation(10000, ANIM_ID[animId]);
    end
    
    if CheckButton(BTN_R1) then
        if (CheckButton(BTN_UP)) then
            NextAnim(deltaVal);
        elseif (CheckButton(BTN_DOWN)) then
            PrevAnim(deltaVal);
        end
    else
        if (CheckButtonPressed(BTN_UP)) then
            NextAnim(deltaVal);
        elseif (CheckButtonPressed(BTN_DOWN)) then
            PrevAnim(deltaVal);
        end
    end
    
    textFormat = "[LB/RB:ListFast, L3/R3:ListEnds, Y:PlayLoop, A:PlayOnce, B:Stop] AnimID: %d".."("..mode..")";
    
    SetKeyGuideText(string.format(textFormat, ANIM_ID[animId]));
end

function UpdatePrevVals()
    prevButtonBitmaskValue = buttonBitmaskValue;
end

--On Startup: 
ForcePlayLoopAnimation(10000, animId);
SetTextPositions();
PrintClearAll();
SetLineHelpTextClear();

while true do 
    ReadController();
    UpdatePlayback();
    UpdatePrevVals();
    Wait(33);
end